name: Merge Queue Benchmarks
on:
  merge_group:

concurrency:
  group: merge-queue-${{ github.ref }}
  cancel-in-progress: true

permissions:
  pull-requests: write

jobs:
  full-benchmark:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - run: rustup show

      - name: Install cmake
        run: sudo apt-get update && sudo apt-get install -y cmake

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: bench-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: bench-${{ runner.os }}-

      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - run: pip install matplotlib

      # ---- base (main) benchmark ----
      - run: git checkout ${{ github.event.merge_group.base_sha }}
      - run: cargo bench -p rtmalloc-bench --bench alloc_bench -- --noplot
      - run: cp -r target/criterion target/criterion-base

      # ---- merge candidate benchmark ----
      - run: git checkout ${{ github.event.merge_group.head_sha }}
      - run: rm -rf target/criterion
      - run: cargo bench -p rtmalloc-bench --bench alloc_bench -- --noplot

      # ---- compare ----
      - run: |
          python3 .github/scripts/extract-criterion.py \
            --base target/criterion-base \
            --head target/criterion \
            --output-comment bench-comment.md \
            --output-charts bench-charts

      - uses: actions/upload-artifact@v4
        with:
          name: merge-queue-benchmark-charts
          path: bench-charts/
          retention-days: 30
