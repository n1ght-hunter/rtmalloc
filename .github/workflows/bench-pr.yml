name: Benchmark PR
on:
  pull_request:
    branches: [main]
    paths: ['src/**', 'rseq/**', 'bench/**', 'Cargo.toml', 'Cargo.lock']

concurrency:
  group: bench-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  pull-requests: write

jobs:
  benchmark:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - run: rustup show

      - name: Install cmake
        run: sudo apt-get update && sudo apt-get install -y cmake

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: bench-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: bench-${{ runner.os }}-

      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - run: pip install matplotlib

      # ---- base branch ----
      - run: git checkout ${{ github.event.pull_request.base.sha }}
      - run: cargo bench -p rstcmalloc-bench --bench alloc_bench -- --noplot
      - run: cp -r target/criterion target/criterion-base

      # ---- PR branch ----
      - run: git checkout ${{ github.event.pull_request.head.sha }}
      - run: rm -rf target/criterion
      - run: cargo bench -p rstcmalloc-bench --bench alloc_bench -- --noplot

      # ---- compare & comment ----
      - run: |
          python3 .github/scripts/extract-criterion.py \
            --base target/criterion-base \
            --head target/criterion \
            --output-comment bench-comment.md \
            --output-charts bench-charts

      - uses: actions/upload-artifact@v4
        with:
          name: benchmark-charts
          path: bench-charts/
          retention-days: 30

      - name: Append chart link to comment
        run: |
          ARTIFACT_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          printf '\n\n---\n' >> bench-comment.md
          printf '**Benchmark charts:** [Download SVGs](%s) (under Artifacts)\n' "$ARTIFACT_URL" >> bench-comment.md

      - uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: benchmark-comparison
          path: bench-comment.md
